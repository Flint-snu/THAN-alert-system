<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>THAN 3D Alert View</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #cesiumContainer { width: 100%; height: 100vh; }
    #uiControls {
        position: absolute;
        top: 20px; left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        color: white;
        z-index: 100;
        font-family: sans-serif;
    }
    .btn {
        background: #ff4444;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .btn:hover { background: #cc0000; }
  </style>
</head>
<body>

  <div id="uiControls">
    <h3>THAN 3D Alert Simulation</h3>
    <p>Status: <span id="statusText">Normal</span></p>
    <button class="btn" onclick="triggerAlarm()">Test Alarm (Red)</button>
  </div>

  <div id="cesiumContainer"></div>

  <script>

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5YWYwYTdiOS1hNmQzLTRlYzMtOWVmOS01YzY1ZGM2MGI2ZjMiLCJpZCI6MzY0NDk2LCJpYXQiOjE3NjQyNDcxNjN9.AEqypLl5NB-ONvei0d-ToJtE589IpC51cDPf49Stv1U'; 

    
    // 1. Initialize Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      animation: false,
      timeline: false,
      baseLayerPicker: false,
      shadows: true,
    });

    // 2. Enable Lighting
    viewer.scene.globe.enableLighting = true;
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 3. Add Buildings
    const buildingsTileset = viewer.scene.primitives.add(Cesium.createOsmBuildings());
    buildingsTileset.style = new Cesium.Cesium3DTileStyle({
        color: {
            conditions: [
                ['true', 'color("#F2F2F2")']
            ]
        }
    });

    // 4. Fly to China Location (Based on your Admin Code: 25.93, 108.52)
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(108.529, 25.933, 1500), // Updated Long, Lat
      orientation: {
        heading: Cesium.Math.toRadians(0.0),
        pitch: Cesium.Math.toRadians(-25.0),
      }
    });

    // 5. Speaker Pole Visualization
    // Updated Location
    const speakerLocation = Cesium.Cartesian3.fromDegrees(108.529, 25.933);

    viewer.entities.add({
        position: speakerLocation,
        cylinder: {
            length: 40.0,
            topRadius: 1.0,
            bottomRadius: 1.0,
            material: Cesium.Color.CYAN.withAlpha(0.9),
            outline: true,
            outlineColor: Cesium.Color.BLACK
        }
    });

    // 6. Alarm Animation Logic
    let isAlarmActive = false;
    let currentRadius = 10.0;

    function addSoundWave() {
        viewer.entities.add({
            position: speakerLocation,
            ellipse: {
                semiMinorAxis: new Cesium.CallbackProperty(() => {
                    if (!isAlarmActive) return 0;
                    currentRadius += 8;
                    if (currentRadius > 500) currentRadius = 10; 
                    return currentRadius;
                }, false),
                semiMajorAxis: new Cesium.CallbackProperty(() => {
                    if (!isAlarmActive) return 0;
                    return currentRadius;
                }, false),
                material: new Cesium.ColorMaterialProperty(
                    new Cesium.CallbackProperty(() => {
                        const alpha = 1.0 - (currentRadius / 500);
                        return Cesium.Color.RED.withAlpha(alpha * 0.7);
                    }, false)
                ),
                height: 30.0,
                outline: true,
                outlineColor: Cesium.Color.RED
            }
        });
    }

    addSoundWave();

    function triggerAlarm() {
        isAlarmActive = true;
        document.getElementById('statusText').innerText = "EMERGENCY ALERT ACTIVATED!";
        document.getElementById('statusText').style.color = "#ff3333";
        document.getElementById('statusText').style.fontWeight = "bold";
    }
  </script>
</body>
</html>