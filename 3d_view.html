<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>THAN 3D Alert View</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #cesiumContainer { width: 100%; height: 100vh; }
    #uiControls {
        position: absolute;
        top: 20px; left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        color: white;
        z-index: 100;
        font-family: sans-serif;
    }
    .btn {
        background: #ff4444;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 4px;
        margin-top: 10px;
    }
    .btn:hover { background: #cc0000; }
  </style>
</head>
<body>

  <div id="uiControls">
    <h3>THAN 3D Alert Simulation</h3>
    <p>Status: <span id="statusText">Normal</span></p>
    <button class="btn" onclick="triggerAlarm()">Test Alarm (Red)</button>
  </div>

  <div id="cesiumContainer"></div>

  <script>

    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5YWYwYTdiOS1hNmQzLTRlYzMtOWVmOS01YzY1ZGM2MGI2ZjMiLCJpZCI6MzY0NDk2LCJpYXQiOjE3NjQyNDcxNjN9.AEqypLl5NB-ONvei0d-ToJtE589IpC51cDPf49Stv1U'; 

    
   // 1. Initialize Viewer
    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      animation: false,
      timeline: false,
      baseLayerPicker: false,
      shadows: true,
      selectionIndicator: false,
      infoBox: false
    });

    // 2. Enable Lighting
    viewer.scene.globe.enableLighting = true;
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // Center Location (China Coordinates)
    const centerLon = 108.52;
    const centerLat = 25.93;
    const centerPoint = Cesium.Cartesian3.fromDegrees(centerLon, centerLat);

    // 3. Create "Dummy City" (Since rural areas lack OSM buildings)
    // We will create a grid of boxes to represent a town
    const gridSize = 0.001; // Spacing between buildings
    for (let x = -3; x <= 3; x++) {
        for (let y = -3; y <= 3; y++) {
            if (x === 0 && y === 0) continue; // Leave center empty for Speaker

            const height = 20 + Math.random() * 40; // Random height 20m-60m
            
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(centerLon + (x * gridSize), centerLat + (y * gridSize), height / 2),
                box: {
                    dimensions: new Cesium.Cartesian3(80.0, 80.0, height),
                    material: Cesium.Color.WHITE.withAlpha(0.9),
                    outline: true,
                    outlineColor: Cesium.Color.BLACK
                }
            });
        }
    }

    // 4. Fly Camera Closer (Look at the center)
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(centerLon, centerLat - 0.01, 800), // Height 800m
      orientation: {
        heading: Cesium.Math.toRadians(0.0), // Facing North
        pitch: Cesium.Math.toRadians(-20.0), // Look down slightly
      }
    });

    // 5. Huge Speaker Pole (Visual for Demo)
    viewer.entities.add({
        position: centerPoint,
        cylinder: {
            length: 150.0, // Make it TALL so we can see it
            topRadius: 5.0,
            bottomRadius: 5.0,
            material: Cesium.Color.CYAN.withAlpha(0.9), // Neon Blue
            outline: true,
            outlineColor: Cesium.Color.BLACK
        }
    });

    // 6. Alarm Animation Logic
    let isAlarmActive = false;
    let currentRadius = 10.0;

    function addSoundWave() {
        viewer.entities.add({
            position: centerPoint,
            ellipse: {
                semiMinorAxis: new Cesium.CallbackProperty(() => {
                    if (!isAlarmActive) return 0;
                    currentRadius += 15; // Speed up
                    if (currentRadius > 1200) currentRadius = 10; // Wider range
                    return currentRadius;
                }, false),
                semiMajorAxis: new Cesium.CallbackProperty(() => {
                    if (!isAlarmActive) return 0;
                    return currentRadius;
                }, false),
                material: new Cesium.ColorMaterialProperty(
                    new Cesium.CallbackProperty(() => {
                        const alpha = 1.0 - (currentRadius / 1200);
                        return Cesium.Color.RED.withAlpha(alpha * 0.6);
                    }, false)
                ),
                height: 100.0, // Float above ground
                outline: true,
                outlineColor: Cesium.Color.RED
            }
        });
    }

    addSoundWave();

    // Trigger Function
    function triggerAlarm() {
        isAlarmActive = true;
        document.getElementById('statusText').innerText = "EMERGENCY ALERT ACTIVATED!";
        document.getElementById('statusText').style.color = "#ff3333";
        document.getElementById('statusText').style.fontWeight = "bold";
    }
  </script>
</body>
</html>